<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link rel="stylesheet" href="test.css">

    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            /* background-color: gainsboro; */
        }

        /* Layout 영역 */
        #root {
            display: flex;
        }

        #list {
            display: flex;
            flex-direction: column;
            background-color: dimgray;
            width: 40vw;
            height: 100vh;
        }

        #result {
            margin: 10px;
            width: 50vw;
            height: 50vh;
            border: 1px solid black;
            background-color: white;
            overflow: scroll;
        }

        #menu {
            border: 1px solid black;
            display: flex;
            flex-direction: column;
            width: 25px;
            height: auto;
        }

        #m1 {
            border: 1px solid grey;
            background-color: black;
            width: 20px;
            height: 3px;
            margin: 0.5px;
        }

        /* Chat 영역 */
    </style>
</head>

<body>
    <form action="/text" method="post">
        <!-- 최상위 id -->
        <div id="root">
            <!-- 왼쪽 목록 및 로그인 정보  -->
            <div id="list">
                <div id="menu">
                    <div id="m1"></div>
                    <div id="m1"></div>
                    <div id="m1"></div>
                </div>
                <!-- 메시지 title -->
                <ul id="title">
                    내용 없음
                    <!-- 사용자가 입력했던 메시지 title -->
                </ul>
                <!-- 로그인 정보 -->
                <div id="info">
                    신동현 <br>
                    <img src="" alt="프로필 사진">
                </div>
            </div>

            <!-- 메시지 영역 -->
            <div id="chatArea" name="chatArea">
                <!-- 메시지 입력 결과 -->
                <div id="result"></div>
                <!-- 메시지 입력 화면 -->
                <label for="chat">메시지 입력</label>
                <input id="chat" type="text" name="chat" placeholder="메시지 입력">
                <input id="send" type="button" name="send" value="입력">
            </div>
        </div>
    </form>

    <script>
        const result = document.getElementById("result");
        const chat = document.getElementById("chat");
        const send = document.getElementById("send");
        const info = document.getElementById("info");
        const title = document.getElementById("title");

        // 입력한 데이터를 data.json으로 key의 맞춰 전송
        send.addEventListener("click", function (event) {
            if (chat.value === "") {
                alert("내용을 입력해주세요!");
                chat.focus();
            } else {
                const message = chat.value;
                const timestamp = new Date().toLocaleTimeString();
                const chatData = {
                    type: "user",
                    message: message,
                    timestamp: timestamp
                };

                // JSON 데이터를 서버로 전송
                fetch("/text", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(chatData)
                })
                .then(response => response.json())
                .then(data => {
                    // 서버에서 전달된 응답 처리 (필요하면)
                    console.log(data);
                });

                const li = document.createElement("li");
                li.textContent = `${chatData.type}: ${chatData.message} (${chatData.timestamp})`;
                result.appendChild(li);
                chat.value = "";
                chat.focus();
            }
        });

        function fetchDataAndUpdateUI() {
            fetch("/data")
            .then(response => response.json())
            .then(data => {
                // data 객체에서 필요한 정보를 가져와 사용
                const hamburgerMenu = data.hamburgerMenu;
                const inputRecords = data.inputRecords;
                const userInfo = data.userInfo;

                // TODO: 가져온 데이터를 활용하여 UI를 업데이트하는 작업 수행
                const messageData = inputRecords.Date || "채팅내역을 불러 올 수 없음";
                result.textContent = messageData;

                inputRecords.forEach(record => {
                    const li = document.createElement("li");
                    li.textContent = `${record.type} : ${record.message} [${record.Date}]`;
                    result.appendChild(li);
                });
                setInterval(fetchDataAndUpdateUI, 1000);

                const userName = userInfo.name || "Unknown"; // name이 없으면 "Unknown"을 사용
                info.textContent = userName;
                const userStatus = userInfo.status || "알 수 없음";
                title.textContent = userStatus;

                console.log(inputRecords);
                console.log(userInfo);
            })
            .catch(error => {
                console.error("Error fetching data:", error);
            });
        }

        // 클라이언트에서 데이터를 서버로 전송하는 코드 (이 부분은 이미 주어진 코드에 있음)
        // 클라이언트에서 데이터를 가져와서 UI를 업데이트하는 코드
        fetchDataAndUpdateUI();
    </script>
</body>

</html>
